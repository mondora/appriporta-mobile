!function(t){if("function"==typeof bootstrap)bootstrap("promise",t);else if("object"==typeof exports)module.exports=t();else if("function"==typeof define&&define.amd)define(t);else if("undefined"!=typeof ses){if(!ses.ok())return;ses.makeQ=t}else Q=t()}(function(){"use strict";function t(t){return function(){return V.apply(t,arguments)}}function e(t){return t===Object(t)}function n(t){return"[object StopIteration]"===ee(t)||t instanceof q}function o(t,e){if(J&&e.stack&&"object"==typeof t&&null!==t&&t.stack&&-1===t.stack.indexOf(ne)){for(var n=[],o=e;o;o=o.source)o.stack&&n.unshift(o.stack);n.unshift(t.stack);var i=n.join("\n"+ne+"\n");t.stack=r(i)}}function r(t){for(var e=t.split("\n"),n=[],o=0;o<e.length;++o){var r=e[o];c(r)||i(r)||!r||n.push(r)}return n.join("\n")}function i(t){return-1!==t.indexOf("(module.js:")||-1!==t.indexOf("(node.js:")}function s(t){var e=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(t);if(e)return[e[1],Number(e[2])];var n=/at ([^ ]+):(\d+):(?:\d+)$/.exec(t);if(n)return[n[1],Number(n[2])];var o=/.*@(.+):(\d+)$/.exec(t);return o?[o[1],Number(o[2])]:void 0}function c(t){var e=s(t);if(!e)return!1;var n=e[0],o=e[1];return n===W&&o>=$&&se>=o}function u(){if(J)try{throw new Error}catch(t){var e=t.stack.split("\n"),n=e[0].indexOf("@")>0?e[1]:e[2],o=s(n);if(!o)return;return W=o[0],o[1]}}function a(t,e,n){return function(){return"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn(e+" is deprecated, use "+n+" instead.",new Error("").stack),t.apply(t,arguments)}}function p(t){return v(t)?t:m(t)?I(t):C(t)}function l(){function t(t){e=t,i.source=t,H(n,function(e,n){G(function(){t.promiseDispatch.apply(t,n)})},void 0),n=void 0,o=void 0}var e,n=[],o=[],r=Y(l.prototype),i=Y(h.prototype);if(i.promiseDispatch=function(t,r,i){var s=z(arguments);n?(n.push(s),"when"===r&&i[1]&&o.push(i[1])):G(function(){e.promiseDispatch.apply(e,s)})},i.valueOf=function(){if(n)return i;var t=y(e);return v(t)&&(e=t),t},i.inspect=function(){return e?e.inspect():{state:"pending"}},p.longStackSupport&&J)try{throw new Error}catch(s){i.stack=s.stack.substring(s.stack.indexOf("\n")+1)}return r.promise=i,r.resolve=function(n){e||t(p(n))},r.fulfill=function(n){e||t(C(n))},r.reject=function(n){e||t(R(n))},r.notify=function(t){e||H(o,function(e,n){G(function(){n(t)})},void 0)},r}function d(t){if("function"!=typeof t)throw new TypeError("resolver must be a function.");var e=l();try{t(e.resolve,e.reject,e.notify)}catch(n){e.reject(n)}return e.promise}function f(t){return d(function(e,n){for(var o=0,r=t.length;r>o;o++)p(t[o]).then(e,n)})}function h(t,e,n){void 0===e&&(e=function(t){return R(new Error("Promise does not support operation: "+t))}),void 0===n&&(n=function(){return{state:"unknown"}});var o=Y(h.prototype);if(o.promiseDispatch=function(n,r,i){var s;try{s=t[r]?t[r].apply(o,i):e.call(o,r,i)}catch(c){s=R(c)}n&&n(s)},o.inspect=n,n){var r=n();"rejected"===r.state&&(o.exception=r.reason),o.valueOf=function(){var t=n();return"pending"===t.state||"rejected"===t.state?o:t.value}}return o}function _(t,e,n,o){return p(t).then(e,n,o)}function y(t){if(v(t)){var e=t.inspect();if("fulfilled"===e.state)return e.value}return t}function v(t){return e(t)&&"function"==typeof t.promiseDispatch&&"function"==typeof t.inspect}function m(t){return e(t)&&"function"==typeof t.then}function g(t){return v(t)&&"pending"===t.inspect().state}function k(t){return!v(t)||"fulfilled"===t.inspect().state}function b(t){return v(t)&&"rejected"===t.inspect().state}function w(){oe.length=0,re.length=0,ie||(ie=!0)}function S(t,e){ie&&(re.push(t),oe.push(e&&"undefined"!=typeof e.stack?e.stack:"(no stack) "+e))}function j(t){if(ie){var e=K(re,t);-1!==e&&(re.splice(e,1),oe.splice(e,1))}}function R(t){var e=h({when:function(e){return e&&j(this),e?e(t):this}},function(){return this},function(){return{state:"rejected",reason:t}});return S(e,t),e}function C(t){return h({when:function(){return t},get:function(e){return t[e]},set:function(e,n){t[e]=n},"delete":function(e){delete t[e]},post:function(e,n){return null===e||void 0===e?t.apply(void 0,n):t[e].apply(t,n)},apply:function(e,n){return t.apply(e,n)},keys:function(){return te(t)}},void 0,function(){return{state:"fulfilled",value:t}})}function I(t){var e=l();return G(function(){try{t.then(e.resolve,e.reject,e.notify)}catch(n){e.reject(n)}}),e.promise}function O(t){return h({isDef:function(){}},function(e,n){return L(t,e,n)},function(){return p(t).inspect()})}function E(t,e,n){return p(t).spread(e,n)}function T(t){return function(){function e(t,e){var s;if("undefined"==typeof StopIteration){try{s=o[t](e)}catch(c){return R(c)}return s.done?s.value:_(s.value,r,i)}try{s=o[t](e)}catch(c){return n(c)?c.value:R(c)}return _(s,r,i)}var o=t.apply(this,arguments),r=e.bind(e,"next"),i=e.bind(e,"throw");return r()}}function x(t){p.done(p.async(t)())}function N(t){throw new q(t)}function A(t){return function(){return E([this,U(arguments)],function(e,n){return t.apply(e,n)})}}function L(t,e,n){return p(t).dispatch(e,n)}function U(t){return _(t,function(t){var e=0,n=l();return H(t,function(o,r,i){var s;v(r)&&"fulfilled"===(s=r.inspect()).state?t[i]=s.value:(++e,_(r,function(o){t[i]=o,0===--e&&n.resolve(t)},n.reject,function(t){n.notify({index:i,value:t})}))},void 0),0===e&&n.resolve(t),n.promise})}function D(t){return _(t,function(t){return t=X(t,p),_(U(X(t,function(t){return _(t,B,B)})),function(){return t})})}function Q(t){return p(t).allSettled()}function F(t,e){return p(t).then(void 0,void 0,e)}function P(t,e){return p(t).nodeify(e)}var J=!1;try{throw new Error}catch(M){J=!!M.stack}var W,q,$=u(),B=function(){},G=function(){function t(){for(;e.next;){e=e.next;var n=e.task;e.task=void 0;var r=e.domain;r&&(e.domain=void 0,r.enter());try{n()}catch(s){if(i)throw r&&r.exit(),setTimeout(t,0),r&&r.enter(),s;setTimeout(function(){throw s},0)}r&&r.exit()}o=!1}var e={task:void 0,next:null},n=e,o=!1,r=void 0,i=!1;if(G=function(t){n=n.next={task:t,domain:i&&process.domain,next:null},o||(o=!0,r())},"undefined"!=typeof process&&process.nextTick)i=!0,r=function(){process.nextTick(t)};else if("function"==typeof setImmediate)r="undefined"!=typeof window?setImmediate.bind(window,t):function(){setImmediate(t)};else if("undefined"!=typeof MessageChannel){var s=new MessageChannel;s.port1.onmessage=function(){r=c,s.port1.onmessage=t,t()};var c=function(){s.port2.postMessage(0)};r=function(){setTimeout(t,0),c()}}else r=function(){setTimeout(t,0)};return G}(),V=Function.call,z=t(Array.prototype.slice),H=t(Array.prototype.reduce||function(t,e){var n=0,o=this.length;if(1===arguments.length)for(;;){if(n in this){e=this[n++];break}if(++n>=o)throw new TypeError}for(;o>n;n++)n in this&&(e=t(e,this[n],n));return e}),K=t(Array.prototype.indexOf||function(t){for(var e=0;e<this.length;e++)if(this[e]===t)return e;return-1}),X=t(Array.prototype.map||function(t,e){var n=this,o=[];return H(n,function(r,i,s){o.push(t.call(e,i,s,n))},void 0),o}),Y=Object.create||function(t){function e(){}return e.prototype=t,new e},Z=t(Object.prototype.hasOwnProperty),te=Object.keys||function(t){var e=[];for(var n in t)Z(t,n)&&e.push(n);return e},ee=t(Object.prototype.toString);q="undefined"!=typeof ReturnValue?ReturnValue:function(t){this.value=t};var ne="From previous event:";p.resolve=p,p.nextTick=G,p.longStackSupport=!1,p.defer=l,l.prototype.makeNodeResolver=function(){var t=this;return function(e,n){e?t.reject(e):t.resolve(arguments.length>2?z(arguments,1):n)}},p.Promise=d,p.promise=d,d.race=f,d.all=U,d.reject=R,d.resolve=p,p.passByCopy=function(t){return t},h.prototype.passByCopy=function(){return this},p.join=function(t,e){return p(t).join(e)},h.prototype.join=function(t){return p([this,t]).spread(function(t,e){if(t===e)return t;throw new Error("Can't join: not the same: "+t+" "+e)})},p.race=f,h.prototype.race=function(){return this.then(p.race)},p.makePromise=h,h.prototype.toString=function(){return"[object Promise]"},h.prototype.then=function(t,e,n){function r(e){try{return"function"==typeof t?t(e):e}catch(n){return R(n)}}function i(t){if("function"==typeof e){o(t,c);try{return e(t)}catch(n){return R(n)}}return R(t)}function s(t){return"function"==typeof n?n(t):t}var c=this,u=l(),a=!1;return G(function(){c.promiseDispatch(function(t){a||(a=!0,u.resolve(r(t)))},"when",[function(t){a||(a=!0,u.resolve(i(t)))}])}),c.promiseDispatch(void 0,"when",[void 0,function(t){var e,n=!1;try{e=s(t)}catch(o){if(n=!0,!p.onerror)throw o;p.onerror(o)}n||u.notify(e)}]),u.promise},p.when=_,h.prototype.thenResolve=function(t){return this.then(function(){return t})},p.thenResolve=function(t,e){return p(t).thenResolve(e)},h.prototype.thenReject=function(t){return this.then(function(){throw t})},p.thenReject=function(t,e){return p(t).thenReject(e)},p.nearer=y,p.isPromise=v,p.isPromiseAlike=m,p.isPending=g,h.prototype.isPending=function(){return"pending"===this.inspect().state},p.isFulfilled=k,h.prototype.isFulfilled=function(){return"fulfilled"===this.inspect().state},p.isRejected=b,h.prototype.isRejected=function(){return"rejected"===this.inspect().state};var oe=[],re=[],ie=!0;p.resetUnhandledRejections=w,p.getUnhandledReasons=function(){return oe.slice()},p.stopUnhandledRejectionTracking=function(){w(),ie=!1},w(),p.reject=R,p.fulfill=C,p.master=O,p.spread=E,h.prototype.spread=function(t,e){return this.all().then(function(e){return t.apply(void 0,e)},e)},p.async=T,p.spawn=x,p["return"]=N,p.promised=A,p.dispatch=L,h.prototype.dispatch=function(t,e){var n=this,o=l();return G(function(){n.promiseDispatch(o.resolve,t,e)}),o.promise},p.get=function(t,e){return p(t).dispatch("get",[e])},h.prototype.get=function(t){return this.dispatch("get",[t])},p.set=function(t,e,n){return p(t).dispatch("set",[e,n])},h.prototype.set=function(t,e){return this.dispatch("set",[t,e])},p.del=p["delete"]=function(t,e){return p(t).dispatch("delete",[e])},h.prototype.del=h.prototype["delete"]=function(t){return this.dispatch("delete",[t])},p.mapply=p.post=function(t,e,n){return p(t).dispatch("post",[e,n])},h.prototype.mapply=h.prototype.post=function(t,e){return this.dispatch("post",[t,e])},p.send=p.mcall=p.invoke=function(t,e){return p(t).dispatch("post",[e,z(arguments,2)])},h.prototype.send=h.prototype.mcall=h.prototype.invoke=function(t){return this.dispatch("post",[t,z(arguments,1)])},p.fapply=function(t,e){return p(t).dispatch("apply",[void 0,e])},h.prototype.fapply=function(t){return this.dispatch("apply",[void 0,t])},p["try"]=p.fcall=function(t){return p(t).dispatch("apply",[void 0,z(arguments,1)])},h.prototype.fcall=function(){return this.dispatch("apply",[void 0,z(arguments)])},p.fbind=function(t){var e=p(t),n=z(arguments,1);return function(){return e.dispatch("apply",[this,n.concat(z(arguments))])}},h.prototype.fbind=function(){var t=this,e=z(arguments);return function(){return t.dispatch("apply",[this,e.concat(z(arguments))])}},p.keys=function(t){return p(t).dispatch("keys",[])},h.prototype.keys=function(){return this.dispatch("keys",[])},p.all=U,h.prototype.all=function(){return U(this)},p.allResolved=a(D,"allResolved","allSettled"),h.prototype.allResolved=function(){return D(this)},p.allSettled=Q,h.prototype.allSettled=function(){return this.then(function(t){return U(X(t,function(t){function e(){return t.inspect()}return t=p(t),t.then(e,e)}))})},p.fail=p["catch"]=function(t,e){return p(t).then(void 0,e)},h.prototype.fail=h.prototype["catch"]=function(t){return this.then(void 0,t)},p.progress=F,h.prototype.progress=function(t){return this.then(void 0,void 0,t)},p.fin=p["finally"]=function(t,e){return p(t)["finally"](e)},h.prototype.fin=h.prototype["finally"]=function(t){return t=p(t),this.then(function(e){return t.fcall().then(function(){return e})},function(e){return t.fcall().then(function(){throw e})})},p.done=function(t,e,n,o){return p(t).done(e,n,o)},h.prototype.done=function(t,e,n){var r=function(t){G(function(){if(o(t,i),!p.onerror)throw t;p.onerror(t)})},i=t||e||n?this.then(t,e,n):this;"object"==typeof process&&process&&process.domain&&(r=process.domain.bind(r)),i.then(void 0,r)},p.timeout=function(t,e,n){return p(t).timeout(e,n)},h.prototype.timeout=function(t,e){var n=l(),o=setTimeout(function(){n.reject(new Error(e||"Timed out after "+t+" ms"))},t);return this.then(function(t){clearTimeout(o),n.resolve(t)},function(t){clearTimeout(o),n.reject(t)},n.notify),n.promise},p.delay=function(t,e){return void 0===e&&(e=t,t=void 0),p(t).delay(e)},h.prototype.delay=function(t){return this.then(function(e){var n=l();return setTimeout(function(){n.resolve(e)},t),n.promise})},p.nfapply=function(t,e){return p(t).nfapply(e)},h.prototype.nfapply=function(t){var e=l(),n=z(t);return n.push(e.makeNodeResolver()),this.fapply(n).fail(e.reject),e.promise},p.nfcall=function(t){var e=z(arguments,1);return p(t).nfapply(e)},h.prototype.nfcall=function(){var t=z(arguments),e=l();return t.push(e.makeNodeResolver()),this.fapply(t).fail(e.reject),e.promise},p.nfbind=p.denodeify=function(t){var e=z(arguments,1);return function(){var n=e.concat(z(arguments)),o=l();return n.push(o.makeNodeResolver()),p(t).fapply(n).fail(o.reject),o.promise}},h.prototype.nfbind=h.prototype.denodeify=function(){var t=z(arguments);return t.unshift(this),p.denodeify.apply(void 0,t)},p.nbind=function(t,e){var n=z(arguments,2);return function(){function o(){return t.apply(e,arguments)}var r=n.concat(z(arguments)),i=l();return r.push(i.makeNodeResolver()),p(o).fapply(r).fail(i.reject),i.promise}},h.prototype.nbind=function(){var t=z(arguments,0);return t.unshift(this),p.nbind.apply(void 0,t)},p.nmapply=p.npost=function(t,e,n){return p(t).npost(e,n)},h.prototype.nmapply=h.prototype.npost=function(t,e){var n=z(e||[]),o=l();return n.push(o.makeNodeResolver()),this.dispatch("post",[t,n]).fail(o.reject),o.promise},p.nsend=p.nmcall=p.ninvoke=function(t,e){var n=z(arguments,2),o=l();return n.push(o.makeNodeResolver()),p(t).dispatch("post",[e,n]).fail(o.reject),o.promise},h.prototype.nsend=h.prototype.nmcall=h.prototype.ninvoke=function(t){var e=z(arguments,1),n=l();return e.push(n.makeNodeResolver()),this.dispatch("post",[t,e]).fail(n.reject),n.promise},p.nodeify=P,h.prototype.nodeify=function(t){return t?void this.then(function(e){G(function(){t(null,e)})},function(e){G(function(){t(e)})}):this};var se=u();return p}),function(t,e){"function"==typeof define&&define.amd?define(e):"object"==typeof exports?module.exports=e():t.DDP=e()}(this,function(){"use strict";var t=function(){var t=0;return function(){return(t++).toString()}}(),e='{"server_id":"0"}',n=10,o=300,r=1e4,i=["added","changed","connected","error","failed","nosub","ready","removed","result","updated","ping","pong"],s=function(t){this._endpoint=t.endpoint,this._SocketConstructor=t.SocketConstructor,this._autoreconnect=!t.do_not_autoreconnect,this._ping_interval=t._ping_interval||r,this._socketInterceptFunction=t.socketInterceptFunction,this._onReadyCallbacks={},this._onStopCallbacks={},this._onErrorCallbacks={},this._onResultCallbacks={},this._onUpdatedCallbacks={},this._events={},this._queue=[],this.readyState=-1,this._reconnect_count=0,this._reconnect_incremental_timer=0,t.do_not_autoconnect||this.connect()};return s.prototype.constructor=s,s.prototype.connect=function(){this.readyState=0,this._socket=new this._SocketConstructor(this._endpoint),this._socket.onopen=this._on_socket_open.bind(this),this._socket.onmessage=this._on_socket_message.bind(this),this._socket.onerror=this._on_socket_error.bind(this),this._socket.onclose=this._on_socket_close.bind(this)},s.prototype.method=function(e,n,o,r){var i=t();return this._onResultCallbacks[i]=o,this._onUpdatedCallbacks[i]=r,this._send({msg:"method",id:i,method:e,params:n}),i},s.prototype.sub=function(e,n,o,r,i){var s=t();return this._onReadyCallbacks[s]=o,this._onStopCallbacks[s]=r,this._onErrorCallbacks[s]=i,this._send({msg:"sub",id:s,name:e,params:n}),s},s.prototype.unsub=function(t){return this._send({msg:"unsub",id:t}),t},s.prototype.on=function(t,e){this._events[t]=this._events[t]||[],this._events[t].push(e)},s.prototype.off=function(t,e){if(this._events[t]){var n=this._events[t].indexOf(e);-1!==n&&this._events[t].splice(n,1)}},s.prototype._emit=function(t){if(this._events[t]){var e=arguments,n=this;this._events[t].forEach(function(t){t.apply(n,Array.prototype.slice.call(e,1))})}},s.prototype._send=function(t){if(1!==this.readyState&&"connect"!==t.msg)return void this._queue.push(t);var e;e="undefined"==typeof EJSON?JSON.stringify(t):EJSON.stringify(t),this._socketInterceptFunction&&this._socketInterceptFunction({type:"socket_message_sent",message:e,timestamp:Date.now()}),this._socket.send(e)},s.prototype._try_reconnect=function(){this._reconnect_count<n?(setTimeout(this.connect.bind(this),this._reconnect_incremental_timer),this._reconnect_count+=1,this._reconnect_incremental_timer+=o*this._reconnect_count):setTimeout(this.connect.bind(this),this._reconnect_incremental_timer)},s.prototype._on_result=function(t){if(this._onResultCallbacks[t.id])this._onResultCallbacks[t.id](t.error,t.result),delete this._onResultCallbacks[t.id],t.error&&delete this._onUpdatedCallbacks[t.id];else if(t.error)throw delete this._onUpdatedCallbacks[t.id],t.error},s.prototype._on_updated=function(t){var e=this;t.methods.forEach(function(t){e._onUpdatedCallbacks[t]&&(e._onUpdatedCallbacks[t](),delete e._onUpdatedCallbacks[t])})},s.prototype._on_nosub=function(t){if(t.error){if(!this._onErrorCallbacks[t.id])throw delete this._onReadyCallbacks[t.id],delete this._onStopCallbacks[t.id],new Error(t.error);return this._onErrorCallbacks[t.id](t.error),delete this._onReadyCallbacks[t.id],delete this._onStopCallbacks[t.id],void delete this._onErrorCallbacks[t.id]}this._onStopCallbacks[t.id]&&this._onStopCallbacks[t.id](),delete this._onReadyCallbacks[t.id],delete this._onStopCallbacks[t.id],delete this._onErrorCallbacks[t.id]},s.prototype._on_ready=function(t){var e=this;t.subs.forEach(function(t){e._onReadyCallbacks[t]&&(e._onReadyCallbacks[t](),delete e._onReadyCallbacks[t])})},s.prototype._on_error=function(t){this._emit("error",t)},s.prototype._on_connected=function(e){var n=this,o=0===n._reconnect_count,r=o?"connected":"reconnected";n.readyState=1,n._reconnect_count=0,n._reconnect_incremental_timer=0;for(var i=n._queue.length,s=0;i>s;s++)n._send(n._queue.shift());n._emit(r,e),n._ping_interval_handle=setInterval(function(){var e=t();n._send({msg:"ping",id:e})},n._ping_interval)},s.prototype._on_failed=function(t){this.readyState=4,this._emit("failed",t)},s.prototype._on_added=function(t){this._emit("added",t)},s.prototype._on_removed=function(t){this._emit("removed",t)},s.prototype._on_changed=function(t){this._emit("changed",t)},s.prototype._on_ping=function(t){this._send({msg:"pong",id:t.id})},s.prototype._on_pong=function(){},s.prototype._on_socket_close=function(){this._socketInterceptFunction&&this._socketInterceptFunction({type:"socket_close",timestamp:Date.now()}),clearInterval(this._ping_interval_handle),this.readyState=4,this._emit("socket_close"),this._autoreconnect&&this._try_reconnect()},s.prototype._on_socket_error=function(t){this._socketInterceptFunction&&this._socketInterceptFunction({type:"socket_error",error:JSON.stringify(t),timestamp:Date.now()}),clearInterval(this._ping_interval_handle),this.readyState=4,this._emit("socket_error",t)},s.prototype._on_socket_open=function(){this._socketInterceptFunction&&this._socketInterceptFunction({type:"socket_open",timestamp:Date.now()}),this._send({msg:"connect",version:"pre2",support:["pre2"]})},s.prototype._on_socket_message=function(t){this._socketInterceptFunction&&this._socketInterceptFunction({type:"socket_message_received",message:t.data,timestamp:Date.now()});var n;if(t.data!==e){try{if(n="undefined"==typeof EJSON?JSON.parse(t.data):EJSON.parse(t.data),-1===i.indexOf(n.msg))throw new Error}catch(o){return console.warn("Non DDP message received:"),void console.warn(t.data)}this["_on_"+n.msg](n)}},s}),function(t,e){"function"==typeof define&&define.amd?define(e):"object"==typeof exports?module.exports=e():t.Asteroid=e()}(this,function(){"use strict";function t(t){if("undefined"!=typeof EJSON)return EJSON.clone(t);var e=typeof t;switch(e){case"undefined":case"function":return void 0;case"string":case"number":case"boolean":return t;case"object":return null===t?null:JSON.parse(JSON.stringify(t));default:return}}function e(t){var e="";for(var n in t)e+=n+"="+t[n]+"&";return e=e.slice(0,-1)}function n(){for(var t="",e=0;8>e;e++)t+=Math.floor(65536*(1+Math.random())).toString(16).substring(1);return t}function o(t){return-1!==t.indexOf("@")}var r=function(){};r.prototype={constructor:r,on:function(t,e){this._events||(this._events={}),this._events[t]=this._events[t]||[],this._events[t].push(e)},off:function(t,e){this._events||(this._events={}),this._events[t]&&this._events[t].splice(this._events[t].indexOf(e),1)},_emit:function(t){if(this._events||(this._events={}),this._events[t]){var e=arguments,n=this;this._events[t].forEach(function(t){t.apply(n,Array.prototype.slice.call(e,1))})}}};var i={};i._toString=function(t){return Object.prototype.toString.call(t).slice(8,-1)},i.beString=function(t){var e=this._toString(t);if("String"!==e)throw new Error("Assertion failed: expected String, instead got "+e)},i.beArray=function(t){var e=this._toString(t);if("Array"!==e)throw new Error("Assertion failed: expected Array, instead got "+e)},i.beObject=function(t){var e=this._toString(t);if("Object"!==e)throw new Error("Assertion failed: expected Object, instead got "+e)};var s=function(t,e,n){i.beString(t),this._host=(e?"https://":"http://")+t,this._ddpOptions="function"==typeof SockJS?{endpoint:(e?"https://":"http://")+t+"/sockjs",SocketConstructor:SockJS,socketInterceptFunction:n}:{endpoint:(e?"wss://":"ws://")+t+"/websocket",SocketConstructor:WebSocket,socketInterceptFunction:n},this.collections={},this.subscriptions={},this._subscriptionsCache={},this._init()};s.prototype=Object.create(r.prototype),s.prototype.constructor=s,s.prototype._init=function(){var t=this;t.ddp=new DDP(this._ddpOptions),t.ddp.on("connected",function(){t.resumeLoginPromise=t._tryResumeLogin(),t.subscribe("meteor.loginServiceConfiguration"),t._emit("connected")}),t.ddp.on("reconnected",function(){t.resumeLoginPromise=t._tryResumeLogin(),t._reEstablishSubscriptions(),t._emit("reconnected")}),t.ddp.on("added",function(e){t._onAdded(e)}),t.ddp.on("changed",function(e){t._onChanged(e)}),t.ddp.on("removed",function(e){t._onRemoved(e)})},s.prototype._onAdded=function(t){var e=t.collection;this.collections[e]||(this.collections[e]=new s._Collection(e,this));var n=t.fields||{};n._id=t.id,this.collections[e]._remoteToLocalInsert(n)},s.prototype._onRemoved=function(t){this.collections[t.collection]&&this.collections[t.collection]._remoteToLocalRemove(t.id)},s.prototype._onChanged=function(t){this.collections[t.collection]&&(t.fields||(t.fields={}),t.cleared&&t.cleared.forEach(function(e){t.fields[e]=void 0}),this.collections[t.collection]._remoteToLocalUpdate(t.id,t.fields))},s.prototype.call=function(t){i.beString(t);var e=Array.prototype.slice.call(arguments,1);return this.apply(t,e)},s.prototype.apply=function(t,e){i.beString(t),Array.isArray(e)||(e=[]);var n=Q.defer(),o=Q.defer(),r=function(t,e){t?(n.reject(t),o.reject()):n.resolve(e)},s=function(){o.resolve()};return this.ddp.method(t,e,r,s),{result:n.promise,updated:o.promise}},s.prototype.getCollection=function(t){return i.beString(t),this.collections[t]||(this.collections[t]=new s._Collection(t,this)),this.collections[t]};var c="__del__",u="__upd__",a=function(t){var e=c.length,n=u.length,o=t.slice(-1*e),r=t.slice(-1*n);return o===c||r===u},p=function(t,e){this.name=t,this.asteroid=e,this._set=new f};p.prototype.constructor=p,p.prototype._localToLocalInsert=function(t){if(this._set.contains(t._id))throw new Error("Item "+t._id+" already exists");return this._set.put(t._id,t),Q(t._id)},p.prototype._remoteToLocalInsert=function(t){this._set.put(t._id,t)},p.prototype._localToRemoteInsert=function(t){var e=this,n=Q.defer(),o="/"+e.name+"/insert";return e.asteroid.ddp.method(o,[t],function(o){o?(e._set.del(t._id),n.reject(o)):n.resolve(t._id)}),n.promise},p.prototype.insert=function(t){return t._id||(t._id=n()),{local:this._localToLocalInsert(t),remote:this._localToRemoteInsert(t)}},p.prototype._localToLocalRemove=function(t){var e=this._set.get(t);return e&&(this._set.put(t+c,e),this._set.del(t)),Q(t)},p.prototype._remoteToLocalRemove=function(t){this._set.del(t)},p.prototype._localToRemoteRemove=function(t){var e=this,n=Q.defer(),o="/"+e.name+"/remove";return e.asteroid.ddp.method(o,[{_id:t}],function(o){if(o){var r=e._set.get(t+c);r&&(e._set.put(t,r),e._set.del(t+c)),n.reject(o)}else e._set.del(t+c),n.resolve(t)}),n.promise},p.prototype.remove=function(t){return{local:this._localToLocalRemove(t),remote:this._localToRemoteRemove(t)}},p.prototype._localToLocalUpdate=function(t,e){var n=this._set.get(t);if(!n)throw new Error("Item "+t+" doesn't exist");if(e._id&&e._id!==t)throw new Error("Modifying the _id of a document is not allowed");this._set.put(t+u,n);for(var o in e)n[o]=e[o];return this._set.put(t,n),Q(t)},p.prototype._remoteToLocalUpdate=function(t,e){var n=this._set.get(t);if(!n)return void console.warn("Server misbehaviour: item "+t+" doesn't exist");for(var o in e){if("_id"===o&&e._id!==t)return void console.warn("Server misbehaviour: modifying the _id of a document is not allowed");n[o]=e[o]}this._set.put(t,n)},p.prototype._localToRemoteUpdate=function(t,e){var n=this,o=Q.defer(),r="/"+n.name+"/update",i={_id:t},s={$set:e};return n.asteroid.ddp.method(r,[i,s],function(e){if(e){var r=n._set.get(t+u);n._set.put(t,r),n._set.del(t+u),o.reject(e)}else n._set.del(t+u),o.resolve(t)}),o.promise},p.prototype.update=function(t,e){return{local:this._localToLocalUpdate(t,e),remote:this._localToRemoteUpdate(t,e)}};var l=function(t){var e=this;e.result=[],e._set=t,e._getResult(),e._set.on("put",function(t){e._getResult(),e._emit("change",t)}),e._set.on("del",function(t){e._getResult(),e._emit("change",t)})};l.prototype=Object.create(r.prototype),l.constructor=l,l.prototype._getResult=function(){this.result=this._set.toArray()};var d=function(t){return function(e,n){if(a(e))return!1;var o=function(t,e){return e.split(".").reduce(function(t,e){return t?t=t[e]:t},t)};for(var r in t){var i=o(n,r);if(i!==t[r])return!1}return!0}};p.prototype.reactiveQuery=function(t){var e;e="function"==typeof t?t:d(t);var n=this._set.filter(e);return new l(n)},s._Collection=p,s.prototype._getOauthClientId=function(t){var e="meteor_accounts_loginServiceConfiguration",n=this.collections[e],o=n.reactiveQuery({service:t}).result[0];return o.clientId||o.consumerKey||o.appId},s.prototype._initOauthLogin=function(t,e,n){var o=window.open(n,"_blank","location=no,toolbar=no");o.focus&&o.focus();var r=this;return Q().then(function(){var t=Q.defer();if(window.cordova)o.addEventListener("loadstop",function(n){if(-1!==n.url.indexOf("#")){var r=n.url.indexOf("#"),i=n.url.slice(r+1).split("&");if(i[0]&&"credentialToken"===i[0].split("=")[0]&&i[1]&&"credentialSecret"===i[1].split("=")[0]){var s=i[0].split("=")[1],c=i[1].split("=")[1];s===e&&(t.resolve(c),o.close())}}});else{var n=JSON.stringify({credentialToken:e}),i=setInterval(function(){o.postMessage(n,r._host)},100);window.addEventListener("message",function(n){var o;try{o=JSON.parse(n.data)}catch(s){return}n.origin===r._host&&(o.credentialToken===e&&(clearInterval(i),t.resolve(o.credentialSecret)),o.error&&(clearInterval(i),t.reject(o.error)))})}return t.promise}).then(function(t){var n=Q.defer(),o={oauth:{credentialToken:e,credentialSecret:t}};return r.ddp.method("login",[o],function(t,e){t?(delete r.userId,delete r.loggedIn,delete localStorage[r._host+"__login_token__"],n.reject(t),r._emit("loginError",t)):(r.userId=e.id,r.loggedIn=!0,localStorage[r._host+"__login_token__"]=e.token,r._emit("login",e.id),n.resolve(e.id))}),n.promise})},s.prototype._tryResumeLogin=function(){var t=this,e=Q.defer(),n=localStorage[t._host+"__login_token__"];if(!n)return e.reject("No login token"),e.promise;var o={resume:n};return t.ddp.method("login",[o],function(n,o){n?(delete t.userId,delete t.loggedIn,delete localStorage[t._host+"__login_token__"],t._emit("loginError",n),e.reject(n)):(t.userId=o.id,t.loggedIn=!0,localStorage[t._host+"__login_token__"]=o.token,t._emit("login",o.id),e.resolve(o.id))}),e.promise},s.prototype.loginWithFacebook=function(t){var o=n(),r={client_id:this._getOauthClientId("facebook"),redirect_uri:this._host+"/_oauth/facebook?close",state:o,scope:t||"email"},i="https://www.facebook.com/dialog/oauth?"+e(r);return this._initOauthLogin("facebook",o,i)},s.prototype.loginWithGoogle=function(t){var o=n(),r={response_type:"code",client_id:this._getOauthClientId("google"),redirect_uri:this._host+"/_oauth/google?close",state:o,scope:t||"openid email"},i="https://accounts.google.com/o/oauth2/auth?"+e(r);return this._initOauthLogin("google",o,i)},s.prototype.loginWithGithub=function(t){var o=n(),r={client_id:this._getOauthClientId("github"),redirect_uri:this._host+"/_oauth/github?close",state:o,scope:t||"email"},i="https://github.com/login/oauth/authorize?"+e(r);return this._initOauthLogin("github",o,i)},s.prototype.loginWithTwitter=function(){var t=n(),o=this._host+"/_oauth/twitter?close&state="+t,r={requestTokenAndRedirect:encodeURIComponent(o),state:t},i=this._host+"/_oauth/twitter/?"+e(r);return this._initOauthLogin("twitter",t,i)},s.prototype.createUser=function(t,e,n){var r=this,i=Q.defer(),s={username:o(t)?void 0:t,email:o(t)?t:void 0,password:e,profile:n};return r.ddp.method("createUser",[s],function(t,e){t?(r._emit("createUserError",t),i.reject(t)):(r.userId=e.id,r.loggedIn=!0,localStorage[r._host+"__login_token__"]=e.token,r._emit("createUser",e.id),r._emit("login",e.id),i.resolve(e.id))}),i.promise},s.prototype.loginWithPassword=function(t,e){var n=this,r=Q.defer(),i={password:e,user:{username:o(t)?void 0:t,email:o(t)?t:void 0}};return n.ddp.method("login",[i],function(t,e){t?(delete n.userId,delete n.loggedIn,delete localStorage[n._host+"__login_token__"],r.reject(t),n._emit("loginError",t)):(n.userId=e.id,n.loggedIn=!0,localStorage[n._host+"__login_token__"]=e.token,n._emit("login",e.id),r.resolve(e.id))}),r.promise},s.prototype.logout=function(){var t=this,e=Q.defer();return t.ddp.method("logout",[],function(n){n?(t._emit("logoutError",n),e.reject(n)):(delete t.userId,delete t.loggedIn,delete localStorage[t._host+"__login_token__"],t._emit("logout"),e.resolve())}),e.promise};var f=function(t){t&&(this._put=this.put,this._del=this.del,this.put=this.del=function(){throw new Error("Attempt to modify readonly set")}),this._items={}};f.prototype=Object.create(r.prototype),f.constructor=f,f.prototype.put=function(e,n){return i.beString(e),i.beObject(n),this._items[e]=t(n),this._emit("put",e),this},f.prototype.del=function(t){return i.beString(t),delete this._items[t],this._emit("del",t),this},f.prototype.get=function(e){return i.beString(e),t(this._items[e])},f.prototype.contains=function(t){return i.beString(t),!!this._items[t]},f.prototype.filter=function(e){var n=new f(!0),o=this._items,r=Object.keys(o);return r.forEach(function(r){var i=t(o[r]),s=e(r,i);s&&(n._items[r]=o[r])}),this.on("put",function(r){var i=t(o[r]),s=e(r,i);s&&n._put(r,o[r])}),this.on("del",function(t){n._del(t)}),n},f.prototype.toArray=function(){var e=[],n=this._items,o=Object.keys(this._items);return o.forEach(function(t){e.push(n[t])}),t(e)},f.prototype.toHash=function(){return t(this._items)},s.Set=f;var h=function(t,e,n,o){this._name=t,this._params=e,this._hash=n,this._asteroid=o,this._ready=Q.defer(),this.ready=this._ready.promise;var r=this._onReady.bind(this),i=this._onStop.bind(this),s=this._onError.bind(this);this.id=o.ddp.sub(t,e,r,i,s)};return h.constructor=h,h.prototype.stop=function(){this._asteroid.ddp.unsub(this.id),delete this._asteroid._subscriptionsCache[this._hash]},h.prototype._onReady=function(){this._ready.resolve(this.id)},h.prototype._onStop=function(){delete this._asteroid.subscriptions[this.id]
},h.prototype._onError=function(t){this.ready.isPending()&&this._ready.reject(t),delete this._asteroid.subscriptions[this.id]},s.prototype.subscribe=function(t){i.beString(t);var e=Array.prototype.slice.call(arguments),n=JSON.stringify(e);if(!this._subscriptionsCache[n]){var o=e.slice(1),r=new h(t,o,n,this);this._subscriptionsCache[n]=r,this.subscriptions[r.id]=r}return this._subscriptionsCache[n]},s.prototype._reEstablishSubscriptions=function(){var t=this.subscriptions;for(var e in t)t.hasOwnProperty(e)&&(t[e]=new h(t[e]._name,t[e]._params,this))},s});